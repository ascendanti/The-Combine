# Claude Unified Personal AI - Docker Stack
version: '3.8'

services:
  # Main daemon - processes task queue
  daemon:
    build:
      context: ./daemon
      dockerfile: Dockerfile
    container_name: claude-daemon
    restart: unless-stopped
    volumes:
      - daemon-data:/data
      - daemon-logs:/logs
      - ./thoughts:/app/thoughts:rw
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_DAEMON_DATA=/data
      - CLAUDE_DAEMON_LOGS=/logs
    networks:
      - claude-net
    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; sqlite3.connect('/data/tasks.db').execute('SELECT 1')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # GitHub webhook receiver
  webhook:
    build:
      context: ./daemon
      dockerfile: Dockerfile
    container_name: claude-webhook
    restart: unless-stopped
    command: ["python", "github_webhook.py", "--port", "8080"]
    ports:
      - "8080:8080"
    volumes:
      - daemon-data:/data
    environment:
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET}
    networks:
      - claude-net
    depends_on:
      - daemon

  # OpenMemory backend (optional - uses local SQLite if not available)
  # Uncomment if you have OpenMemory server running
  # openmemory:
  #   image: openmemory/server:latest
  #   container_name: claude-memory
  #   restart: unless-stopped
  #   volumes:
  #     - memory-data:/data
  #   networks:
  #     - claude-net

volumes:
  daemon-data:
    name: claude-daemon-data
  daemon-logs:
    name: claude-daemon-logs
  # memory-data:
  #   name: claude-memory-data

networks:
  claude-net:
    name: claude-network
    driver: bridge
